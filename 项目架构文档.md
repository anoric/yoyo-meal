# Yoyo-Meal 项目架构文档

## 项目概述

Yoyo-Meal 是一个基于 Flask 框架开发的 Web 应用程序，主要用于提供计数器功能。该项目采用 MVC 架构模式，支持 MySQL 数据库存储，并可以部署到云环境中。

## 技术栈

- **后端框架**: Flask 2.0.2
- **数据库**: MySQL (通过 PyMySQL 1.0.2 连接)
- **ORM**: SQLAlchemy 1.4.29 + Flask-SQLAlchemy 2.5.1
- **Python 版本**: 3.9
- **容器化**: Docker
- **模板引擎**: Jinja2 3.0.3

## 项目结构

```
yoyo-meal/
├── config.py                 # 配置文件
├── run.py                   # 应用启动入口
├── requirements.txt         # Python依赖包列表
├── Dockerfile              # Docker容器配置
├── container.config.json   # 容器配置文件
├── README.md               # 项目说明文档
├── LICENSE                 # 开源许可证
└── wxcloudrun/             # 主要业务模块
    ├── __init__.py         # Flask应用初始化
    ├── views.py           # 视图控制器
    ├── model.py           # 数据模型
    ├── dao.py             # 数据访问层
    └── response.py        # 响应处理工具
```

## 核心模块详解

### 1. 应用初始化 (`wxcloudrun/__init__.py`)

- **功能**: 初始化 Flask 应用实例和数据库连接
- **关键配置**:
  - 数据库连接字符串: `mysql://用户名:密码@地址/数据库名`
  - 使用 PyMySQL 替代 MySQLDB (Python3 兼容性)
  - 自动加载视图控制器

### 2. 数据模型 (`wxcloudrun/model.py`)

#### Counters 表结构

```python
class Counters(db.Model):
    __tablename__ = 'Counters'

    id = db.Column(db.Integer, primary_key=True)           # 主键ID
    count = db.Column(db.Integer, default=1)               # 计数值
    created_at = db.Column('createdAt', db.TIMESTAMP)     # 创建时间
    updated_at = db.Column('updatedAt', db.TIMESTAMP)     # 更新时间
```

#### User 表结构

```python
class User(db.Model):
    __tablename__ = 'Users'

    uid = db.Column(db.String(50), primary_key=True)       # 用户唯一标识
    nickname = db.Column(db.String(100), nullable=False)    # 用户昵称
    avatar = db.Column(db.String(500))                     # 用户头像URL
    created_at = db.Column('createdAt', db.TIMESTAMP, nullable=False, default=datetime.now())  # 创建时间
```

### 3. 数据访问层 (`wxcloudrun/dao.py`)

提供数据库操作的封装方法：

**计数器相关操作**:

- `query_counterbyid(id)`: 根据 ID 查询计数器
- `delete_counterbyid(id)`: 根据 ID 删除计数器
- `insert_counter(counter)`: 插入新的计数器记录
- `update_counterbyid(counter)`: 更新计数器值

**用户相关操作**:

- `query_user_by_uid(uid)`: 根据 UID 查询用户
- `query_all_users()`: 查询所有用户
- `insert_user(user)`: 插入新用户
- `update_user_by_uid(user)`: 根据 UID 更新用户信息
- `delete_user_by_uid(uid)`: 根据 UID 删除用户

**特点**:

- 统一的异常处理机制
- 操作日志记录
- 事务管理

### 4. 视图控制器 (`wxcloudrun/views.py`)

#### API 接口

##### POST `/api/count` - 计数器操作

**功能**: 执行计数器的增加或清零操作

**请求参数**:

```json
{
    "action": "inc" | "clear"
}
```

**操作类型**:

- `inc`: 自增操作
  - 如果计数器不存在，创建新记录(count=1)
  - 如果计数器存在，count 值+1
- `clear`: 清零操作
  - 删除 ID 为 1 的计数器记录

**响应格式**:

```json
{
  "code": 0, // 0: 成功, -1: 失败
  "data": 5, // 当前计数值
  "errorMsg": "错误信息" // 仅在失败时返回
}
```

##### GET `/api/count` - 获取计数值

**功能**: 查询当前计数器的值

**响应格式**:

```json
{
  "code": 0,
  "data": 5 // 计数值，如果不存在则返回0
}
```

#### 用户管理接口

##### POST `/api/users` - 创建用户

**功能**: 创建新用户

**请求参数**:

```json
{
  "uid": "user123", // 用户唯一标识(必需)
  "nickname": "用户昵称", // 用户昵称(必需)
  "avatar": "头像URL" // 用户头像(可选)
}
```

**响应格式**:

```json
{
  "code": 0,
  "data": {
    "uid": "user123",
    "nickname": "用户昵称",
    "avatar": "头像URL",
    "createdAt": "2024-01-01T00:00:00"
  }
}
```

##### GET `/api/users/<uid>` - 获取用户信息

**功能**: 根据 UID 查询用户信息

**响应格式**:

```json
{
  "code": 0,
  "data": {
    "uid": "user123",
    "nickname": "用户昵称",
    "avatar": "头像URL",
    "createdAt": "2024-01-01T00:00:00"
  }
}
```

##### GET `/api/users` - 获取所有用户

**功能**: 查询所有用户列表

**响应格式**:

```json
{
  "code": 0,
  "data": [
    {
      "uid": "user123",
      "nickname": "用户昵称",
      "avatar": "头像URL",
      "createdAt": "2024-01-01T00:00:00"
    }
  ]
}
```

##### PUT `/api/users/<uid>` - 更新用户信息

**功能**: 更新用户信息

**请求参数**:

```json
{
  "nickname": "新昵称", // 用户昵称(可选)
  "avatar": "新头像URL" // 用户头像(可选)
}
```

**响应格式**:

```json
{
  "code": 0,
  "data": {
    "uid": "user123",
    "nickname": "新昵称",
    "avatar": "新头像URL",
    "createdAt": "2024-01-01T00:00:00"
  }
}
```

##### DELETE `/api/users/<uid>` - 删除用户

**功能**: 删除指定用户

**响应格式**:

```json
{
  "code": 0,
  "data": {}
}
```

### 5. 响应处理 (`wxcloudrun/response.py`)

提供统一的 API 响应格式：

- `make_succ_empty_response()`: 成功响应(无数据)
- `make_succ_response(data)`: 成功响应(带数据)
- `make_err_response(err_msg)`: 错误响应

**标准响应格式**:

```json
{
  "code": 0, // 状态码: 0=成功, -1=失败
  "data": {}, // 响应数据
  "errorMsg": "" // 错误信息(仅失败时)
}
```

### 6. 配置管理 (`config.py`)

- **DEBUG 模式**: 开发环境调试开关
- **数据库配置**: 通过环境变量读取数据库连接信息
  - `MYSQL_USERNAME`: 数据库用户名
  - `MYSQL_PASSWORD`: 数据库密码
  - `MYSQL_ADDRESS`: 数据库地址和端口

## 部署配置

### Docker 容器化

**基础镜像**: Alpine Linux 3.13
**Python 版本**: Python 3.9
**端口**: 80
**启动命令**: `python3 run.py 0.0.0.0 80`

**Dockerfile 特点**:

- 使用国内镜像源加速下载
- 自动安装项目依赖
- 配置 HTTPS 证书支持
- 支持时区设置(可选)

### 环境变量

| 变量名         | 默认值         | 说明             |
| -------------- | -------------- | ---------------- |
| MYSQL_USERNAME | root           | MySQL 用户名     |
| MYSQL_PASSWORD | root           | MySQL 密码       |
| MYSQL_ADDRESS  | 127.0.0.1:3306 | MySQL 地址和端口 |

## 数据库设计

### Counters 表

| 字段名    | 类型      | 约束        | 说明      |
| --------- | --------- | ----------- | --------- |
| id        | Integer   | Primary Key | 计数器 ID |
| count     | Integer   | Default: 1  | 计数值    |
| createdAt | TIMESTAMP | Not Null    | 创建时间  |
| updatedAt | TIMESTAMP | Not Null    | 更新时间  |

### Users 表

| 字段名    | 类型        | 约束        | 说明         |
| --------- | ----------- | ----------- | ------------ |
| uid       | String(50)  | Primary Key | 用户唯一标识 |
| nickname  | String(100) | Not Null    | 用户昵称     |
| avatar    | String(500) | Nullable    | 用户头像 URL |
| createdAt | TIMESTAMP   | Not Null    | 创建时间     |

## API 使用示例

### 1. 增加计数

```bash
curl -X POST http://localhost/api/count \
  -H "Content-Type: application/json" \
  -d '{"action": "inc"}'
```

### 2. 清零计数

```bash
curl -X POST http://localhost/api/count \
  -H "Content-Type: application/json" \
  -d '{"action": "clear"}'
```

### 3. 查询计数

```bash
curl -X GET http://localhost/api/count
```

### 4. 创建用户

```bash
curl -X POST http://localhost/api/users \
  -H "Content-Type: application/json" \
  -d '{"uid": "user123", "nickname": "张三", "avatar": "https://example.com/avatar.jpg"}'
```

### 5. 获取用户信息

```bash
curl -X GET http://localhost/api/users/user123
```

### 6. 获取所有用户

```bash
curl -X GET http://localhost/api/users
```

### 7. 更新用户信息

```bash
curl -X PUT http://localhost/api/users/user123 \
  -H "Content-Type: application/json" \
  -d '{"nickname": "新昵称", "avatar": "https://example.com/new-avatar.jpg"}'
```

### 8. 删除用户

```bash
curl -X DELETE http://localhost/api/users/user123
```

## 开发环境搭建

### 1. 创建虚拟环境

```bash
conda create -n yoyo-meal python=3.9 -y
conda activate yoyo-meal
```

### 2. 安装依赖

```bash
pip install -r requirements.txt
```

### 3. 配置数据库

- 创建 MySQL 数据库: `flask_demo`
- 设置环境变量或修改 `config.py`

### 4. 启动应用

```bash
python run.py 127.0.0.1 5000
```

## 项目特点

1. **模块化设计**: 采用 MVC 架构，代码结构清晰
2. **统一响应格式**: 所有 API 接口使用统一的 JSON 响应格式
3. **异常处理**: 完善的数据库操作异常处理机制
4. **容器化支持**: 完整的 Docker 配置，支持云部署
5. **环境配置**: 支持通过环境变量配置数据库连接
6. **日志记录**: 数据库操作异常自动记录日志

## 扩展建议

1. **认证授权**: 添加用户认证和权限控制
2. **API 文档**: 集成 Swagger 自动生成 API 文档
3. **单元测试**: 添加完整的测试用例
4. **缓存机制**: 使用 Redis 缓存提高性能
5. **监控告警**: 集成应用监控和日志分析
6. **多租户支持**: 支持多用户独立计数

---

_文档生成时间: 2024 年_
_项目版本: 基于 Flask 2.0.2_
